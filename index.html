<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>‚ö° ‡¶≤‡ßã‡¶°‡¶∂‡ßá‡¶°‡¶ø‡¶Ç ‡¶∞‡¶ø‡¶ï‡¶≠‡¶æ‡¶∞‡¶ø ‚Äî Ultimate Mindblow ‚ö°</title>
<style>
/* -----------------------------
   GLOBAL & FONTS
   ----------------------------- */
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Noto+Sans+Bengali:wght@400;700&display=swap');

:root{
  --w:900px; --h:650px;
  --accent:#00f0ff; --accent-2:#00b3ff; --bg-dark:#030307;
  --glass: rgba(255,255,255,0.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Noto Sans Bengali', sans-serif;background:radial-gradient(circle at 20% 10%, #071126 0%, #000 35%);color:#eafcff}
.container{width:var(--w);height:var(--h);margin:28px auto;border-radius:12px;overflow:hidden;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.7), 0 0 80px rgba(0,180,255,0.06);background:linear-gradient(180deg,#02060a 0%, #071426 100%)}

/* top neon bar */
.topbar{height:62px;background:linear-gradient(90deg, rgba(0,255,255,0.06), rgba(0,170,255,0.04));display:flex;align-items:center;justify-content:space-between;padding:10px 18px;gap:12px}
.title{display:flex;gap:12px;align-items:center}
.title h1{font-family:'Orbitron',sans-serif;font-size:18px;color:var(--accent);text-shadow:0 0 10px rgba(0,240,255,0.12)}
.title p{color:#bfefff;margin:0;font-size:13px}
.controls{display:flex;gap:8px;align-items:center}
.small-btn{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#002;cursor:pointer;font-weight:700;box-shadow:0 6px 18px rgba(0,180,255,0.12)}

/* main stage */
.stage{position:relative;height:calc(100% - 62px);display:flex}
.left-panel{width:260px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-right:1px solid rgba(255,255,255,0.03)}
.playarea{flex:1;position:relative;overflow:hidden;background:
 linear-gradient(180deg,#001 0%, #000 60%);display:flex;align-items:center;justify-content:center}

/* HUD / INFO */
.hud-block{background:var(--glass);padding:12px;border-radius:10px;margin-bottom:12px;backdrop-filter: blur(6px);border:1px solid rgba(0,255,255,0.04)}
.hud-item{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.hud-item:last-child{margin-bottom:0}
.label{font-size:13px;color:#cfefff}
.value{font-weight:700;color:#e9ffff}

/* mood bar */
.mood-wrap{display:flex;align-items:center;gap:10px}
.mood-bar{width:140px;height:14px;background:#06121a;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
.mood-progress{height:100%;width:0%;background:linear-gradient(90deg,#ff4e4e,#ff9a3d);transition:width .3s ease}

/* mini-map placeholders */
.map{height:120px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));display:flex;align-items:center;justify-content:center;color:#7fdcff;font-size:12px}

/* playcanvas (center) */
.canvas-wrap{width:100%;height:100%;position:relative;display:flex;align-items:stretch}
.sky{position:absolute;inset:0;background:
  linear-gradient(180deg, rgba(5,18,30,0.7), rgba(0,0,0,0.9));z-index:0}
.road-layer{position:relative;z-index:2;width:100%;height:100%;pointer-events:none}
.scene{position:absolute;inset:0;pointer-events:none}

/* moving background items (parallax) */
.bg-strip{position:absolute;inset:0;overflow:hidden}
.bg-item{position:absolute;width:220px;height:60px;background-repeat:no-repeat;background-size:contain;opacity:0.9;transform:translateY(0);will-change:transform;}

/* flashlight effect */
.flashlight{position:absolute;inset:0;z-index:6;pointer-events:auto;cursor:none;background:radial-gradient(circle 140px at 50% 50%, rgba(255,255,230,0.85), rgba(0,0,0,0.0) 40%), radial-gradient(circle 260px at 50% 50%, rgba(255,255,255,0.04), rgba(0,0,0,0.9) 60%);mix-blend-mode:screen;transition:background 0.09s linear}

/* interactive targets (fuse,meter,pole,cat) */
.target{position:absolute;background-size:contain;background-repeat:no-repeat;background-position:center;opacity:0;transform:scale(.95);transition:opacity .25s ease,transform .12s ease,filter .15s}
.target.lit{opacity:1;transform:scale(1.07);filter:drop-shadow(0 0 18px rgba(0,220,255,0.15));pointer-events:auto}

/* cat animation */
.cat-anim{animation:catMove 2s ease-in-out infinite}
@keyframes catMove{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

/* final screen overlay */
.overlay{position:absolute;inset:0;z-index:12;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.9));display:flex;align-items:center;justify-content:center;flex-direction:column;gap:18px;padding:20px;opacity:0;pointer-events:none;transition:opacity .4s}
.overlay.show{opacity:1;pointer-events:auto}
.overlay h2{color:var(--accent);font-family:'Orbitron',sans-serif;letter-spacing:1px;margin:0}
.overlay p{color:#dffaff;margin:0;max-width:800px;text-align:center}

/* bottom hints */
.hint{position:absolute;left:50%;transform:translateX(-50%);bottom:14px;background:rgba(0,0,0,0.45);padding:6px 12px;border-radius:18px;border:1px solid rgba(0,240,255,0.06);font-size:13px;color:#bff}

/* sparkle particles (canvas) */
canvas.particles{position:absolute;inset:0;z-index:5;pointer-events:none}
</style>
</head>
<body>
<div class="container" role="application" aria-label="Loadshedding Recovery Game">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="title">
      <img src="assets/icon_power.png" alt="" style="width:38px;height:38px;border-radius:6px;filter:drop-shadow(0 4px 12px #00eaff)"/>
      <div>
        <h1>‡¶≤‡ßã‡¶°‡¶∂‡ßá‡¶°‡¶ø‡¶Ç ‡¶∞‡¶ø‡¶ï‡¶≠‡¶æ‡¶∞‡¶ø</h1>
        <p>‡¶Ö‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‚Üí ‡¶∂‡ßá‡¶∑ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶¨‡¶æ‡¶Å‡¶ö‡¶æ‡¶§‡ßá ‡¶≤‡¶°‡¶º‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</p>
      </div>
    </div>

    <div class="controls">
      <button class="small-btn" id="soundToggle">üéß ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶°: ON</button>
      <button class="small-btn" id="saveBtn">üíæ ‡¶∏‡ßá‡¶≠</button>
      <button class="small-btn" id="resetBtn">‚ôªÔ∏è ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
    </div>
  </div>

  <!-- STAGE -->
  <div class="stage">

    <!-- LEFT PANEL: HUD -->
    <aside class="left-panel">
      <div class="hud-block">
        <div class="hud-item"><div class="label">‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü</div><div class="value" id="timerDisplay">00:15</div></div>
        <div class="hud-item mood-wrap">
          <div class="label">‡¶∞‡¶æ‡¶ó</div>
          <div class="mood-bar"><div id="moodProgress" class="mood-progress"></div></div>
        </div>
      </div>

      <div class="hud-block">
        <div class="label">‡¶∏‡ßç‡¶ü‡ßá‡¶ú</div>
        <div class="value" id="stageLabel">‡¶™‡ßç‡¶∞‡¶ø-‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶ï</div>
        <div style="height:8px"></div>
        <div class="label">‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button class="small-btn" id="hintBtn" style="background:transparent;border:1px solid rgba(0,255,255,0.06);color:#9fefff">‡¶π‡¶ø‡¶®‡ßç‡¶ü</button>
          <button class="small-btn" id="mapBtn" style="background:transparent;border:1px solid rgba(0,255,255,0.06);color:#9fefff">‡¶Æ‡¶ø‡¶®‡¶ø-‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™</button>
        </div>
      </div>

      <div class="hud-block map" id="miniMap">‡¶Æ‡¶ø‡¶®‡¶ø-‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ (‡¶ü‡¶æ‡¶ö/‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®)</div>

      <div class="hud-block" style="margin-top:12px">
        <div class="label">‡¶Ö‡¶∞‡ßç‡¶ú‡¶®</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center;width:60px">üèÜ<div style="font-size:12px" id="ach1">‚Äî</div></div>
          <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center;width:60px">üê±<div style="font-size:12px" id="ach2">‚Äî</div></div>
          <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center;width:60px">üìû<div style="font-size:12px" id="ach3">‚Äî</div></div>
        </div>
      </div>
    </aside>

    <!-- PLAY AREA -->
    <main class="playarea">
      <div class="canvas-wrap" id="canvasWrap">
        <div class="sky"></div>

        <!-- moving background items -->
        <div class="bg-strip" id="bgStrip"></div>

        <!-- road + items layer (visual only) -->
        <div class="road-layer" id="roadLayer">
          <!-- targets -->
          <div id="fuse" class="target" style="left:80px;top:180px;width:120px;height:180px;background-image:url('assets/fuse_box.png')"></div>
          <div id="meter" class="target hidden" style="left:630px;top:360px;width:150px;height:150px;background-image:url('assets/meter_box.png')"></div>
          <div id="pole" class="target hidden" style="left:420px;top:100px;width:120px;height:220px;background-image:url('assets/pole.png')"></div>
          <div id="cat" class="target hidden cat-anim" style="left:350px;top:260px;width:120px;height:120px;background-image:url('assets/cat.png')"></div>
        </div>

        <!-- particles -->
        <canvas id="particles" class="particles"></canvas>

        <!-- flashlight overlay (follows cursor/touch) -->
        <div id="flashlight" class="flashlight" tabindex="0" aria-label="Flashlight area"></div>

        <!-- overlay messages / final screen -->
        <div id="overlay" class="overlay" role="dialog" aria-hidden="true">
          <h2 id="overlayTitle">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
          <p id="overlayText">‡¶ï‡¶Æ‡¶™‡ßç‡¶≤‡¶ø‡¶ü ‡¶ó‡¶æ‡¶á‡¶° + ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§</p>
          <div style="display:flex;gap:10px">
            <button class="small-btn" id="startBtn">üéÆ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="small-btn" id="tutorialBtn" style="background:transparent;border:1px solid rgba(0,255,255,0.06);color:#9fefff">‡¶ü‡¶ø‡¶â‡¶ü‡ßã‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</button>
          </div>
        </div>

        <div class="hint" id="hintBubble">‡¶Æ‡¶æ‡¶â‡¶∏ ‡¶¨‡¶æ ‡¶Ü‡¶ô‡ßÅ‡¶≤ ‡¶ò‡ßã‡¶∞‡¶æ‡¶® ‚Äî ‡¶ü‡¶∞‡ßç‡¶ö ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶ï‡¶∞‡¶¨‡ßá</div>
      </div>
    </main>

  </div>

</div>

<!-- AUDIO (placeholders - replace in assets/) -->
<audio id="sndAmb" src="assets/ambient_loop.mp3" loop preload="auto"></audio>
<audio id="sndPowerOn" src="assets/power_on.mp3" preload="auto"></audio>
<audio id="sndError" src="assets/error_buzz.mp3" preload="auto"></audio>
<audio id="sndClick" src="assets/click.mp3" preload="auto"></audio>
<audio id="sndSpark" src="assets/spark.mp3" preload="auto"></audio>

<script>
/* ===================================================
   Ultra-Advanced Game Logic
   - All interactions in one file
   - Touch + Mouse friendly
   - Saves to localStorage
   - Particle spark system
   =================================================== */

(() => {
  // ---- state ----
  const state = {
    currentStep: 0, // 0 pre,1 hunting fuse,1.5 cat,2 meter,3 pole,4 final
    mood: 0,
    timer: 90, // seconds left for emergency save (you can tweak)
    running: false,
    assets: {soundsOn:true},
    found: {fuse:false,cat:false,meter:false,pole:false},
    achievements:{}
  };

  // ---- dom refs ----
  const refs = {
    overlay: document.getElementById('overlay'),
    overlayTitle: document.getElementById('overlayTitle'),
    overlayText: document.getElementById('overlayText'),
    startBtn: document.getElementById('startBtn'),
    tutorialBtn: document.getElementById('tutorialBtn'),
    flash: document.getElementById('flashlight'),
    particles: document.getElementById('particles'),
    bgStrip: document.getElementById('bgStrip'),
    fuse: document.getElementById('fuse'),
    meter: document.getElementById('meter'),
    pole: document.getElementById('pole'),
    cat: document.getElementById('cat'),
    sndAmb: document.getElementById('sndAmb'),
    sndPowerOn: document.getElementById('sndPowerOn'),
    sndError: document.getElementById('sndError'),
    sndClick: document.getElementById('sndClick'),
    sndSpark: document.getElementById('sndSpark'),
    moodBar: document.getElementById('moodProgress'),
    timerDisplay: document.getElementById('timerDisplay'),
    stageLabel: document.getElementById('stageLabel'),
    hintBubble: document.getElementById('hintBubble'),
    soundToggle: document.getElementById('soundToggle'),
    saveBtn: document.getElementById('saveBtn'),
    resetBtn: document.getElementById('resetBtn'),
    miniMap: document.getElementById('miniMap'),
    hintBtn: document.getElementById('hintBtn'),
    mapBtn: document.getElementById('mapBtn'),
    ach1: document.getElementById('ach1'),
    ach2: document.getElementById('ach2'),
    ach3: document.getElementById('ach3'),
    snds: []
  };

  refs.snds = [refs.sndAmb, refs.sndPowerOn, refs.sndError, refs.sndClick, refs.sndSpark];

  // ---- helpers: audio safe play ----
  function playSound(audio){
    if(!state.assets.soundsOn) return;
    try{ audio.currentTime = 0; audio.play().catch(()=>{}); }catch(e){}
  }

  // ---- persistent save/load ----
  function saveState(){
    const save = {
      mood: state.mood, timer: state.timer, currentStep: state.currentStep, found: state.found, achievements: state.achievements
    };
    localStorage.setItem('ls_recovery_save', JSON.stringify(save));
    toast('‡¶ó‡ßá‡¶Æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
  }
  function loadState(){
    const raw = localStorage.getItem('ls_recovery_save');
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      state.mood = s.mood||0; state.timer = s.timer||state.timer; state.currentStep = s.currentStep||0;
      state.found = s.found||state.found; state.achievements = s.achievements||{};
      updateHUD();
      toast('‡¶∏‡ßá‡¶≠ ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    }catch(e){console.warn('load failed',e)}
  }
  function resetState(){
    if(confirm('‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶ö‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
      localStorage.removeItem('ls_recovery_save');
      location.reload();
    }
  }

  // ---- HUD updates ----
  function updateHUD(){
    refs.moodBar.style.width = Math.min(100, state.mood) + '%';
    refs.timerDisplay.textContent = formatTime(state.timer);
    refs.stageLabel.textContent = stepLabel(state.currentStep);
    refs.ach1.textContent = state.achievements.power?'‚úì':'‚Äî';
    refs.ach2.textContent = state.achievements.cat?'‚úì':'‚Äî';
    refs.ach3.textContent = state.achievements.call?'‚úì':'‚Äî';
  }
  function stepLabel(st){ switch(st){
    case 0: return '‡¶™‡ßç‡¶∞‡¶ø-‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶ï';
    case 1: return '‡¶´‡¶ø‡¶â‡¶ú ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ';
    case 1.5: return '‡¶¨‡¶ø‡¶°‡¶º‡¶æ‡¶≤ ‡¶∏‡¶∞‡¶æ‡¶®';
    case 2: return '‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï';
    case 3: return '‡¶ñ‡ßÅ‡¶Å‡¶ü‡¶ø ‡¶ö‡ßá‡¶ï';
    case 4: return '‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤';
    default: return '‡¶Ö‡¶ú‡¶æ‡¶®';
  }}

  // ---- timer loop ----
  let mainTimer = null;
  function startTimer(){
    if(mainTimer) return;
    mainTimer = setInterval(()=>{
      if(!state.running) return;
      state.timer--;
      if(state.timer <= 0){ clearInterval(mainTimer); mainTimer=null; failGame('‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑! ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡¶®‡¶ø'); return; }
      if(state.timer % 1 === 0) updateHUD();
    }, 1000);
  }

  // ---- particles system (canvas) ----
  const canvas = refs.particles; const ctx = canvas.getContext('2d');
  let parts = [];
  function resizeCanvas(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function spawnSparks(x,y,count=10){
    for(let i=0;i<count;i++){
      parts.push({
        x,y,
        vx:(Math.random()-0.5)*3,
        vy:(Math.random()-1.8)*3,
        life: 40 + Math.random()*30,
        size: 1+Math.random()*2,
        color: `rgba(255,${150+Math.floor(Math.random()*100)},0,1)`
      });
    }
  }
  function tickParticles(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let i=parts.length-1;i>=0;i--){
      const p = parts[i];
      p.x += p.vx; p.y += p.vy; p.vy += 0.06; p.life--;
      ctx.beginPath(); ctx.fillStyle = p.color; ctx.globalAlpha = Math.max(0, p.life/80);
      ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
      if(p.life<=0) parts.splice(i,1);
    }
    requestAnimationFrame(tickParticles);
  }
  tickParticles();

  // ---- background parallax items (road motion, up/down) ----
  const bgStrip = refs.bgStrip;
  function makeBgItems(){
    bgStrip.innerHTML = '';
    const items = [
      {img:'assets/bike.png', top:420, speed:1.2},
      {img:'assets/truck.png', top:430, speed:0.9},
      {img:'assets/board1.png', top:160, speed:0.4},
      {img:'assets/leafpile.png', top:480, speed:1.6},
      {img:'assets/pedestrian.png', top:390, speed:1.0},
    ];
    items.forEach((it,idx)=>{
      const el = document.createElement('div'); el.className='bg-item';
      el.style.top = it.top+'px'; el.style.left = (-200 - idx*300) + 'px';
      el.style.backgroundImage = `url('${it.img}')`; el.dataset.speed = it.speed;
      bgStrip.appendChild(el);
    });
  }
  makeBgItems();
  function animateBg(){
    const els = [...bgStrip.children];
    els.forEach(el=>{
      const speed = parseFloat(el.dataset.speed||1);
      let left = parseFloat(el.style.left || 0);
      left += speed * 1.8;
      if(left > window.innerWidth+200) left = -400 - Math.random()*400;
      el.style.left = left + 'px';
    });
    requestAnimationFrame(animateBg);
  }
  animateBg();

  // ---- flash effect follow pointer/touch ----
  const flash = refs.flash;
  let fx = 450, fy = 320;
  function setFlash(x,y,size=140){
    fx = x; fy = y;
    flash.style.background = `radial-gradient(circle ${size}px at ${x}px ${y}px, rgba(255,255,230,0.95), rgba(0,0,0,0.0) 38%), radial-gradient(circle ${size*2.0}px at ${x}px ${y}px, rgba(255,255,255,0.03), rgba(0,0,0,0.9) 62%)`;
  }

  // pointer events
  function onPointerMove(e){
    const rect = flash.getBoundingClientRect();
    const x = (e.touches? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches? e.touches[0].clientY : e.clientY) - rect.top;
    setFlash(x,y,140);
    checkProximity(x,y);
  }
  flash.addEventListener('mousemove', onPointerMove);
  flash.addEventListener('touchmove', onPointerMove,{passive:true});

  // hide cursor but show custom
  document.addEventListener('mousemove', ()=> flash.style.display='block');

  // ---- proximity detection ----
  function elementCenter(el){
    const r = el.getBoundingClientRect(), parent = flash.getBoundingClientRect();
    return {x: r.left - parent.left + r.width/2, y: r.top - parent.top + r.height/2};
  }
  function isNear(px,py,el,threshold=120){
    const c = elementCenter(el);
    const d = Math.hypot(px-c.x, py-c.y);
    return d < threshold;
  }

  function checkProximity(x,y){
    // highlight targets based on step
    [refs.fuse, refs.meter, refs.pole, refs.cat].forEach(t=>t.classList.remove('lit'));
    if(state.currentStep === 1 && isNear(x,y,refs.fuse)){ refs.fuse.classList.add('lit'); refs.hintBubble=''; refs.hintBubble=''; refs.hintBubble}
    if(state.currentStep === 1.5 && isNear(x,y,refs.cat)){ refs.cat.classList.add('lit'); refs.hintBubble}
    if(state.currentStep === 2 && isNear(x,y,refs.meter)){ refs.meter.classList.add('lit') }
    if(state.currentStep === 3 && isNear(x,y,refs.pole)){ refs.pole.classList.add('lit') }
    // show messages
    if(refs.fuse.classList.contains('lit')) showMessage('‡¶´‡¶ø‡¶â‡¶ú ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶Æ‡¶ø‡¶≤‡ßá‡¶õ‡ßá ‚Äî ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®!');
    else if(refs.cat.classList.contains('lit')) showMessage('‡¶¨‡¶ø‡¶°‡¶º‡¶æ‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶õ‡ßá‡¶® ‚Äî ‡¶§‡¶æ‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶® (‡¶ï‡ßç‡¶≤‡¶ø‡¶ï)!');
    else if(refs.meter.classList.contains('lit')) showMessage('‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá ‚Äî ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®!');
    else if(refs.pole.classList.contains('lit')) showMessage('‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ü‡¶ø ‚Äî ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®!');
    else showMessage('‡¶Ö‡¶®‡ßç‡¶ß‡¶ï‡¶æ‡¶∞‡ßá ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶∂‡¶≤‡¶æ‡¶á‡¶ü ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶ò‡ßÅ‡¶∞‡ßÅ‡¶® ‚Äî ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®');
  }

  // ---- interactions ----
  refs.fuse.addEventListener('click', ()=> {
    if(state.currentStep !== 1) return;
    playSound(refs.sndClick);
    state.found.fuse = true;
    state.currentStep = 1.5;
    refs.cat.classList.remove('hidden'); // show cat
    refs.cat.classList.add('lit');
    state.mood += 8; updateHUD();
    showMessage('‡¶´‡¶ø‡¶â‡¶ú ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶¨‡¶ø‡¶°‡¶º‡¶æ‡¶≤ ‡¶ò‡ßÅ‡¶Æ‡¶æ‡¶ö‡ßç‡¶õ‡ßá! ‡¶§‡¶æ‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶® ‚Äî ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶¨‡¶ø‡¶°‡¶º‡¶æ‡¶≤)');
    spawnSparks(fx,fy,20); playSound(refs.sndSpark);
    refs.ach2.textContent = '‚Äî';
  });

  refs.cat.addEventListener('click', ()=> {
    if(state.currentStep !== 1.5) return;
    playSound(refs.sndClick);
    state.found.cat = true; state.achievements.cat = true;
    refs.cat.classList.add('hidden'); refs.cat.classList.remove('lit');
    refs.meter.classList.remove('hidden'); refs.meter.classList.add('lit');
    state.currentStep = 2; state.mood = Math.max(0, state.mood-10); updateHUD();
    showMessage('‡¶¨‡¶ø‡¶°‡¶º‡¶æ‡¶≤ ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã! ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®!');
    spawnSparks(fx,fy,12);
    updateHUD();
  });

  refs.meter.addEventListener('click', ()=> {
    if(state.currentStep !== 2) return;
    playSound(refs.sndClick);
    state.found.meter = true; state.currentStep = 3;
    refs.pole.classList.remove('hidden'); refs.pole.classList.add('lit');
    showPhoneDialMiniGame();
  });

  refs.pole.addEventListener('click', ()=> {
    if(state.currentStep !== 3) return;
    playSound(refs.sndClick);
    refs.pole.classList.remove('lit');
    state.found.pole = true;
    showMessage('‡¶ñ‡ßÅ‡¶Å‡¶ü‡¶ø‡¶§‡ßá ‡¶´‡¶ø‡¶â‡¶ú ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá! ‡¶Æ‡¶æ‡¶†‡ßá ‡¶Ø‡¶æ‡¶® ‡¶ì ‡¶´‡¶ø‡¶â‡¶ú ‡¶Ü‡¶®‡ßÅ‡¶®‡•§ (‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ 3 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶®‡¶ø‡¶®!)');
    setTimeout(()=> {
      // final hunt success
      state.currentStep = 4;
      state.achievements.power = true;
      state.mood = Math.max(0,state.mood-30);
      updateHUD();
      setTimeout(()=> winGame(),2000);
    }, 3000);
  });

  // ---- phone mini-game: simple dial UI ----
  function showPhoneDialMiniGame(){
    // present prompt with simple number input using prompt() for simplicity
    showMessage('‡¶Ö‡¶´‡¶ø‡¶∏‡ßá ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶® ‚Äî ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶™‡ßç‡¶∞‡¶ö‡¶≤‡¶ø‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞: 555)');
    setTimeout(()=>{
      const num = prompt('‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶°‡¶æ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶® (‡ß© ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞)', '');
      if(num === '555'){ playSound(refs.sndClick); showMessage('‡¶ï‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶¨‡¶≤‡¶õ‡ßá: ‡¶´‡¶ø‡¶â‡¶ú ‡¶Æ‡¶æ‡¶†‡ßá ‡¶™‡¶°‡¶º‡ßá ‡¶Ü‡¶õ‡ßá‡•§'); state.achievements.call = true; state.currentStep = 3; updateHUD(); }
      else { state.mood += 12; updateHUD(); playSound(refs.sndError); showMessage('‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞! ‡¶Æ‡ßá‡¶ú‡¶æ‡¶ú ‡¶¨‡¶æ‡ßú‡¶≤‡ßã ‚Äî ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®'); }
    },200);
  }

  // ---- fail / win ----
  function failGame(msg){
    state.running = false;
    playSound(refs.sndError);
    refs.overlay.classList.add('show');
    refs.overlayTitle.textContent = '‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•!';
    refs.overlayText.textContent = msg;
    refs.overlay.setAttribute('aria-hidden','false');
    updateHUD();
  }
  function winGame(){
    state.running = false;
    playSound(refs.sndPowerOn);
    refs.overlay.classList.add('show');
    refs.overlayTitle.textContent = '‡¶¨‡¶ø‡¶ú‡¶Ø‡¶º! ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶´‡¶ø‡¶∞‡ßá ‡¶è‡¶∏‡ßá‡¶õ‡ßá ‚ö°';
    refs.overlayText.textContent = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡ß´ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚Äî ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶≤‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶™ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø ‡¶ï‡¶Æ! (‡¶Ü‡¶∞‡¶ì ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ö‡¶ø‡¶≠‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®)';
    refs.overlay.setAttribute('aria-hidden','false');
    state.achievements.power = true;
    updateHUD();
  }

  // ---- UI messages (temporary) ----
  let msgTimer = null;
  function showMessage(txt, duration=2800){
    refs.hintBubble.textContent = txt;
    refs.hintBubble.style.opacity = '1';
    if(msgTimer) clearTimeout(msgTimer);
    msgTimer = setTimeout(()=>{ refs.hintBubble.style.opacity = '0.95'; }, duration);
  }

  // ---- misc: toast ----
  function toast(t){
    const el = document.createElement('div');
    el.textContent = t; el.style.position='fixed'; el.style.left='20px'; el.style.bottom='20px';
    el.style.padding='8px 12px'; el.style.background='rgba(0,0,0,0.6)'; el.style.color='#bff'; el.style.border='1px solid rgba(0,255,255,0.06)';
    el.style.borderRadius='8px'; document.body.appendChild(el);
    setTimeout(()=>el.remove(),2200);
  }

  // ---- start / overlay handlers ----
  refs.startBtn.addEventListener('click', startGame);
  refs.tutorialBtn.addEventListener('click', ()=> {
    refs.overlayTitle.textContent = '‡¶ü‡¶ø‡¶â‡¶ü‡ßã‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤';
    refs.overlayText.textContent = '‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶ñ‡ßá‡¶≤‡¶¨: ‡¶Æ‡¶æ‡¶â‡¶∏/‡¶Ü‡¶ô‡ßÅ‡¶≤ ‡¶ò‡ßã‡¶∞‡¶æ‡¶®, ‡¶ü‡¶∞‡ßç‡¶ö ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶ï‡¶∞‡¶¨‡ßá‡•§ ‡¶´‡¶ø‡¶â‡¶ú ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶¨‡¶ø‡¶°‡¶º‡¶æ‡¶≤ ‡¶∏‡¶∞‡¶æ‡¶®, ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶Ö‡¶´‡¶ø‡¶∏‡ßá ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶Æ‡¶æ‡¶†‡ßá ‡¶ó‡¶ø‡ßü‡ßá ‡¶´‡¶ø‡¶â‡¶ú ‡¶Ü‡¶∞ ‡¶Ü‡¶®‡ßÅ‡¶®!';
  });

  // sound toggle
  refs.soundToggle.addEventListener('click', ()=> {
    state.assets.soundsOn = !state.assets.soundsOn;
    refs.soundToggle.textContent = 'üéß ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶°: ' + (state.assets.soundsOn? 'ON':'OFF');
    if(state.assets.soundsOn) playSound(refs.sndAmb); else refs.sndAmb.pause();
  });

  // save/reset
  refs.saveBtn.addEventListener('click', saveState);
  refs.resetBtn.addEventListener('click', resetState);

  refs.hintBtn.addEventListener('click', ()=> showMessage('‡¶§‡¶æ‡ßú‡¶æ‡¶§‡¶æ‡ßú‡¶ø! ‡¶´‡¶ø‡¶â‡¶ú ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® ‚Üí ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®',3000));
  refs.mapBtn.addEventListener('click', ()=> { alert('‡¶Æ‡¶ø‡¶®‡¶ø-‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™: ‡¶´‡¶ø‡¶â‡¶ú ‡¶¨‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶ï‡ßá, ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶°‡¶æ‡¶® ‡¶¶‡¶ø‡¶ï‡ßá, ‡¶ñ‡ßÅ‡¶Å‡¶ü‡¶ø ‡¶∏‡¶æ‡¶Æ‡¶®‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá'); });

  // start game flow
  function startGame(){
    refs.overlay.classList.remove('show');
    refs.overlay.setAttribute('aria-hidden','true');
    state.running = true; state.currentStep = 0; // pre
    playSound(refs.sndAmb);
    refs.sndAmb.loop = true;
    // pre-panic countdown
    let pre = 5;
    refs.stageLabel.textContent = '‡¶™‡ßç‡¶∞‡¶ø-‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶ï';
    showMessage('‡¶∂‡ßá‡¶∑ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶π‡¶æ‡¶Å ‡¶¶‡¶ø‡¶ï‡ßá ‚Äî ‡¶≤‡ßã‡¶°‡¶∂‡ßá‡¶°‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶§‡ßá ‡¶Ü‡¶∞ '+pre+' ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°',1200);
    const pInt = setInterval(()=> {
      pre--; showMessage('‡¶≤‡ßã‡¶°‡¶∂‡ßá‡¶°‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶§‡ßá ‡¶Ü‡¶∞ '+pre+' ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°',800);
      if(pre <= 0){
        clearInterval(pInt);
        // start mission
        state.currentStep = 1; refs.stageLabel.textContent = '‡¶´‡¶ø‡¶â‡¶ú ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ';
        showMessage('‡¶≤‡ßã‡¶°‡¶∂‡ßá‡¶°‡¶ø‡¶Ç ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶´‡¶ø‡¶â‡¶ú ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®!');
        // mood increases slowly
        setInterval(()=> { if(state.running) { state.mood = Math.min(100, state.mood + 2); updateHUD(); if(state.mood>=90) failGame('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶æ‡¶ó ‡¶è‡¶§ ‡¶¨‡ßá‡ßú‡ßá ‡¶ó‡ßá‡¶≤‡ßã ‡¶Ø‡ßá ‡¶≤‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶™ ‡¶ï‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶≤'); } }, 1500);
        startTimer(); // start mission timer
      }
    },1000);
  }

  // check proximity in an interval (for keyboard-less detection too)
  setInterval(()=> {
    // nothing heavy
    updateHUD();
  }, 700);

  // vibrations on mobile for important events
  function vibrateShort(){ if(navigator.vibrate) navigator.vibrate(60); }

  // keyboard shortcuts (for fun)
  window.addEventListener('keydown', (e)=> {
    if(e.key === 's') saveState();
    if(e.key === 'r') resetState();
    if(e.key === 'm') { state.assets.soundsOn = !state.assets.soundsOn; refs.soundToggle.textContent = 'üéß ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶°: ' + (state.assets.soundsOn? 'ON':'OFF'); }
  });

  // load saved if exists
  loadState();
  updateHUD();

  // accessibility: enable focus for flashlight to get pointer events on keyboard
  refs.flash.setAttribute('tabindex','0');

  // little ambient spawn to show "power surge" particles around fuse on mouseover
  refs.fuse.addEventListener('mouseenter', ()=> { spawnSparks( elementCenterGlobal(refs.fuse).x, elementCenterGlobal(refs.fuse).y, 25); playSound(refs.sndSpark); vibrateShort(); });
  function elementCenterGlobal(el){
    const r = el.getBoundingClientRect();
    return {x: r.left + r.width/2, y: r.top + r.height/2};
  }

  // small init
  updateHUD();
  showMessage('‡¶ü‡¶ø‡¶™: "s" ‚Üí ‡¶∏‡ßá‡¶≠, "r" ‚Üí ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü',3500);

  // expose some functions for debugging/extension
  window.__LOADSHED = { state, saveState, loadState, startGame, winGame, failGame, spawnSparks };

})(); // end IIFE
</script>
</body>
</html>
